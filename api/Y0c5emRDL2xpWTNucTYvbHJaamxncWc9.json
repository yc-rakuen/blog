{"title":"前端存储","date":"2018-03-12T01:23:02.829Z","excerpt":"","slug":"前端存储","comments":true,"tags":["前端缓存"],"categories":["FE-Basis"],"updated":"2018-03-16T10:07:37.093Z","content":"<p>本篇是前端存储的多种方式和使用场景简介。</p>\n<h2 id=\"Cookie\"><a href=\"#Cookie\" class=\"headerlink\" title=\"Cookie\"></a>Cookie</h2><p>Cookie是服务端传送给客户端，并让客户端保存在本地的小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。</p>\n<h3 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h3><p>Cookie主要用于以下三个方面：</p>\n<ul>\n<li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li>\n<li>个性化设置（如用户自定义设置、主题等）</li>\n<li>浏览器行为跟踪（如跟踪分析用户行为等）</li>\n</ul>\n<h3 id=\"特征\"><a href=\"#特征\" class=\"headerlink\" title=\"特征\"></a>特征</h3><ul>\n<li>大小限制：最大4KB</li>\n<li>一旦设置每次请求都会在请求头中携带</li>\n</ul>\n<h3 id=\"相关API\"><a href=\"#相关API\" class=\"headerlink\" title=\"相关API\"></a>相关API</h3><p>javascript通过<code>document.cookie</code>操作cookies。cookies实际上是一个字符串，其中的值用<code>key=value</code>形式表示，用分号分隔。<code>document.cookie</code>每次只能设置一个cookie。<br>设置cookie时，以下可选属性可以跟在键值对后，用来具体化对cookie的设置或更新，同样使用键值对并以分号作分隔。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">name</th>\n<th style=\"text-align:left\">type</th>\n<th style=\"text-align:left\">description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">expires</td>\n<td style=\"text-align:left\">UTC时间</td>\n<td style=\"text-align:left\">设置过期时间，如果没有定义，cookie将在当前session结束时（关闭浏览器）过期</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">max-age</td>\n<td style=\"text-align:left\">秒数</td>\n<td style=\"text-align:left\">最大存在时间</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">path</td>\n<td style=\"text-align:left\">例如‘/’</td>\n<td style=\"text-align:left\">生效路径，如果没有定义，默认为当前文档位置的路径。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">domain</td>\n<td style=\"text-align:left\">例如“example.com”</td>\n<td style=\"text-align:left\">生效域名包括子域名，如果没有定义，默认为当前文档位置的路径的域名部分。</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">secure</td>\n<td style=\"text-align:left\">设置即生效</td>\n<td style=\"text-align:left\">仅限加密传输，设置后cookie只通过https协议传输</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HttpOnly</td>\n<td style=\"text-align:left\">设置即生效</td>\n<td style=\"text-align:left\">仅限http(s)方式访问，js无法读写</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"使用示例\"><a href=\"#使用示例\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h3><p>读写cookies：<br><figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">document</span>.cookie = <span class=\"string\">\"name=oeschger\"</span>;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.cookie = <span class=\"string\">\"favorite_food=tripe\"</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"built_in\">document</span>.cookie);</span><br><span class=\"line\"><span class=\"comment\">// 显示: name=oeschger;favorite_food=tripe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> myCookie = <span class=\"built_in\">document</span>.cookie.replace(<span class=\"regexp\">/(?:(?:^|.*;\\s*)name\\s*\\=\\s*([^;]*).*$)|^.*$/</span>, <span class=\"string\">\"$1\"</span>);</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(myCookie);</span><br><span class=\"line\"><span class=\"comment\">// 显示：oeschger</span></span><br></pre></td></tr></table></figure></p>\n<p>设置cookies属性：<br><figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">document</span>.cookie = <span class=\"string\">\"password=23333; HttpOnly\"</span>;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"built_in\">document</span>.cookie);</span><br><span class=\"line\"><span class=\"comment\">// 没有打印出刚刚的password</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"SessionStorage与LocalStorage\"><a href=\"#SessionStorage与LocalStorage\" class=\"headerlink\" title=\"SessionStorage与LocalStorage\"></a>SessionStorage与LocalStorage</h2><p>SessionStorage与LocalStorage是Web Storage API提供的两种存储机制，调用其中任一对象会创建 Storage 对象，通过 Storage 对象，可以设置、获取和移除数据项，比Cookies的容量要大，但各浏览器的上限有所不同。主要用于存储一些刷新用数据和用户相关数据，减轻服务器压力。</p>\n<h3 id=\"特征-1\"><a href=\"#特征-1\" class=\"headerlink\" title=\"特征\"></a>特征</h3><p>sessionStorage和localStorage都可以很方便的以key-value形式存储字符串，且自带安全机制，限制只有在设置缓存的域名才能访问。<br>两种机制的区别主要在于生存时间：</p>\n<ul>\n<li>sessionStorage 在页面会话期间可用（即只要浏览器处于打开状态，包括页面重新加载和恢复）。</li>\n<li>localStorage 在浏览器关闭，然后重新打开后数据仍然存在，如果不清理，存储时间是永久。</li>\n</ul>\n<h3 id=\"相关API-1\"><a href=\"#相关API-1\" class=\"headerlink\" title=\"相关API\"></a>相关API</h3><p>这两种缓存分别通过window对象下的sessionStorage和localStorage属性调用，属性方法如下：</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">属性方法</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Storage.length</td>\n<td style=\"text-align:left\">获得storage中的个数</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.key(n)</td>\n<td style=\"text-align:left\">获得storage中第n个元素对的键值（第一个元素是0）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.getItem(key)</td>\n<td style=\"text-align:left\">获取键值key对应的值</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.key</td>\n<td style=\"text-align:left\">获取键值key对应的值</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.setItem(key, value)</td>\n<td style=\"text-align:left\">添加数据，键值为key，值为value</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.removeItem(key)</td>\n<td style=\"text-align:left\">移除键值为key的数据</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Storage.clear()</td>\n<td style=\"text-align:left\">清除所有数据</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"使用示例-1\"><a href=\"#使用示例-1\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h3><p>可以在控制台输入以下代码，然后刷新页面查看计数变化。<br><figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (sessionStorage.pagecount)&#123;</span><br><span class=\"line\">    sessionStorage.pagecount=<span class=\"built_in\">Number</span>(sessionStorage.pagecount) +<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      sessionStorage.pagecount=<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"string\">\"Visits \"</span>+ sessionStorage.pagecount + <span class=\"string\">\" time(s).\"</span>);</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"webSQL与indexedDB\"><a href=\"#webSQL与indexedDB\" class=\"headerlink\" title=\"webSQL与indexedDB\"></a>webSQL与indexedDB</h2><p>webSQL和indexedDB是浏览器端的本地数据库，和服务端数据库类似，可以存储复杂格式的数据，常用于仿app的移动端离线应用。其中webSQL的标准官方已经不打算维护了，转而维护了新的indexedDB，但是webSQL兼容性更好一些，常见移动端浏览器基本都可用。<br>在访问限制和存储时间方面，这两种数据库方式与localStorage一致，限制创建数据库的域名下才可以访问，不能指定域名，存储时间永久。</p>\n<h3 id=\"特征-2\"><a href=\"#特征-2\" class=\"headerlink\" title=\"特征\"></a>特征</h3><ul>\n<li>webSQL更像是关系型数据库，使用sql语句进行操作</li>\n<li>indexedDB更像是nosql，直接使用js的方法操作数据</li>\n</ul>\n<p>API文档详见<br><a href=\"https://dev.w3.org/html5/webdatabase/\" target=\"_blank\" rel=\"noopener\">webSQL</a><br><a href=\"https://www.w3.org/TR/IndexedDB/\" target=\"_blank\" rel=\"noopener\">indexedDB</a></p>\n<h3 id=\"使用示例-2\"><a href=\"#使用示例-2\" class=\"headerlink\" title=\"使用示例\"></a>使用示例</h3><p>使用Chrome打开页面，可以在开发者工具Application（旧版是Resource）标签下Storage模块看到当前域名下的数据库。<br>webSQL示例<br><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!doctype html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"utf-8\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> db = <span class=\"built_in\">window</span>.openDatabase(<span class=\"string\">'testDB'</span>, <span class=\"string\">'1.0'</span>, <span class=\"string\">'TestDb'</span>, <span class=\"number\">2</span> * <span class=\"number\">1024</span> * <span class=\"number\">1024</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">            db.transaction(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">context</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                context.executeSql(<span class=\"string\">'CREATE TABLE IF NOT EXISTS cubefe(id, name)'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">                context.executeSql(<span class=\"string\">'INSERT INTO cubefe (id, name) VALUES (1, \"doctorhou\")'</span>);</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;); </span></span><br><span class=\"line\"><span class=\"undefined\">        </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>indexedDB示例<br><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!doctype html&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">\"utf-8\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> startTime = +<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'starttime:'</span>, startTime);</span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">openDB</span>(<span class=\"params\">dbname, version, cb</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> request = <span class=\"built_in\">window</span>.indexedDB.open(dbname);</span></span><br><span class=\"line\"><span class=\"javascript\">                request.onsuccess = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"keyword\">var</span> db = e.target.result;</span></span><br><span class=\"line\"><span class=\"undefined\">                    myDB.db = db;</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"keyword\">var</span> version = db.version;</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"keyword\">if</span> (!db.objectStoreNames.contains(<span class=\"string\">'students'</span>)) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                        request = db.createObjectStore(<span class=\"string\">'students'</span>, &#123;<span class=\"attr\">autoIncrement</span>: <span class=\"literal\">true</span>&#125;);</span></span><br><span class=\"line\"><span class=\"undefined\">                    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">                    cb &amp;&amp; cb(e);</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;   </span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">            <span class=\"keyword\">var</span> myDB = &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                name: <span class=\"string\">'test'</span>,</span></span><br><span class=\"line\"><span class=\"undefined\">                version: 4,</span></span><br><span class=\"line\"><span class=\"javascript\">                db: <span class=\"literal\">null</span></span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">            openDB(myDB.name, myDB.version, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> db = e.target.result;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> storeName = <span class=\"string\">'students'</span>;</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> transaction = db.transaction(storeName, <span class=\"string\">'readwrite'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> store = transaction.objectStore(storeName);</span></span><br><span class=\"line\"><span class=\"javascript\">                store.put(&#123;<span class=\"attr\">id</span>: <span class=\"number\">2</span>, <span class=\"attr\">name</span>: <span class=\"string\">'doctorhou'</span>&#125;, <span class=\"string\">'b'</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">                <span class=\"keyword\">var</span> request = store.get(<span class=\"number\">1</span>);</span></span><br><span class=\"line\"><span class=\"javascript\">                request.onsuccess = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"built_in\">console</span>.log(request.result);</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"keyword\">var</span> endTime = +<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span></span><br><span class=\"line\"><span class=\"javascript\">                    <span class=\"built_in\">console</span>.log(<span class=\"string\">'take-time:'</span>, endTime - startTime);</span></span><br><span class=\"line\"><span class=\"undefined\">                &#125;;</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;);</span></span><br><span class=\"line\"><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">        </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><p> <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies\" target=\"_blank\" rel=\"noopener\">HTTP Cookies</a><br> <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API\" target=\"_blank\" rel=\"noopener\">Using the Web Storage API</a><br> <a href=\"https://segmentfault.com/a/1190000005927232\" target=\"_blank\" rel=\"noopener\">聊一聊前端存储那些事</a></p>\n","prev":{"title":"前端路由","slug":"前端路由"},"next":{"title":"Git基础操作","slug":"Git基本操作笔记"}}